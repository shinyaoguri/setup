
#######################################
# MIT License
# Copyright (c) 2022 Shinya Oguri
# https://github.com/shinyaoguri/setup
#######################################

# Dynamic Configuration Ansible Playbook
# This playbook reads from selected_packages.yml generated by interactive_setup.sh

- hosts: localhost
  connection: local
  vars_files:
    - "{{ config_file | default('selected_packages.yml') }}"

  tasks:
    ###############
    # Git Configuration
    ###############
    - name: Configure Git global username
      git_config:
        name: user.name
        value: "Shinya Oguri"
        scope: global
      tags:
        - git

    - name: Configure Git global email
      git_config:
        name: user.email
        value: "shinyaoguri@users.noreply.github.com"
        scope: global
      tags:
        - git

    ###############
    # Homebrew packages
    ###############
    - name: Install Homebrew packages
      community.general.homebrew:
        name: "{{ item.name }}"
        state: present
      loop: "{{ homebrew_packages | default([]) }}"
      when: homebrew_packages is defined
      tags:
        - homebrew

    ###############
    # Homebrew Cask packages
    ###############
    - name: Install Homebrew Cask packages
      community.general.homebrew_cask:
        name: "{{ item.name }}"
        state: present
        install_options: "--no-quarantine"
      loop: "{{ homebrew_cask_packages | default([]) }}"
      when: homebrew_cask_packages is defined
      tags:
        - homebrew_cask

    ###############
    # App Store
    ###############
    - name: Install App Store apps
      shell: mas install {{ item }}
      loop: "{{ appstore_apps | default([]) }}"
      when: appstore_apps is defined
      tags:
        - appstore

    ###############
    # Development Environments
    ###############
    - name: Install development environment managers
      shell: |
        if [[ "{{ item }}" == "nodenv" ]]; then
          anyenv install nodenv || true
        elif [[ "{{ item }}" == "rbenv" ]]; then
          anyenv install rbenv || true
        elif [[ "{{ item }}" == "pyenv" ]]; then
          anyenv install pyenv || true
        elif [[ "{{ item }}" == "goenv" ]]; then
          anyenv install goenv || true
        elif [[ "{{ item }}" == "phpenv" ]]; then
          anyenv install phpenv || true
        fi
      loop: "{{ development_environments | default([]) }}"
      when: development_environments is defined
      tags:
        - anyenv

    ###############
    # Fish Shell Configuration
    ###############
    - name: Check if Fish is installed
      stat:
        path: /opt/homebrew/bin/fish
      register: fish_installed
      tags:
        - fish

    - name: Add Fish to /etc/shells
      lineinfile:
        dest: /etc/shells
        line: /opt/homebrew/bin/fish
        state: present
      become: true
      when: fish_installed.stat.exists and ('fish' in (homebrew_packages | default([]) | map(attribute='name') | list))
      tags:
        - fish

    - name: Create Fish config directory
      file:
        path: ~/.config/fish
        state: directory
      when: fish_installed.stat.exists and ('fish' in (homebrew_packages | default([]) | map(attribute='name') | list))
      tags:
        - fish

    - name: Copy Fish configuration
      copy:
        src: config.fish
        dest: ~/.config/fish/config.fish
        force: yes
      when: fish_installed.stat.exists and ('fish' in (homebrew_packages | default([]) | map(attribute='name') | list))
      tags:
        - fish

    ###############
    # Font Installation
    ###############
    - name: Install Nerd Fonts
      community.general.homebrew_cask:
        name: font-hack-nerd-font
        state: present
      when: ('font_hack_nerd_font' in (homebrew_cask_packages | default([]) | map(attribute='name') | list))
      tags:
        - font

    ###############
    # macOS System Settings
    ###############
    - name: Configure Dock auto-hide
      osx_defaults:
        domain: com.apple.dock
        key: autohide
        type: bool
        value: true
        state: present
      when: ('dock_autohide' in (macos_settings | default([])))
      tags:
        - macos

    - name: Configure Dock size
      osx_defaults:
        domain: com.apple.dock
        key: tilesize
        type: int
        value: 36
        state: present
      when: ('dock_size' in (macos_settings | default([])))
      tags:
        - macos

    - name: Show all file extensions
      osx_defaults:
        domain: NSGlobalDomain
        key: AppleShowAllExtensions
        type: bool
        value: true
        state: present
      when: ('finder_show_extensions' in (macos_settings | default([])))
      tags:
        - macos

    - name: Show hidden files in Finder
      osx_defaults:
        domain: com.apple.finder
        key: AppleShowAllFiles
        type: string
        value: "YES"
        state: present
      when: ('finder_show_hidden' in (macos_settings | default([])))
      tags:
        - macos

    - name: Set keyboard repeat rate
      osx_defaults:
        domain: NSGlobalDomain
        key: KeyRepeat
        type: int
        value: 2
        state: present
      when: ('keyboard_repeat' in (macos_settings | default([])))
      tags:
        - macos

    - name: Set initial key repeat delay
      osx_defaults:
        domain: NSGlobalDomain
        key: InitialKeyRepeat
        type: int
        value: 15
        state: present
      when: ('keyboard_repeat' in (macos_settings | default([])))
      tags:
        - macos

    - name: Enable tap to click on trackpad
      osx_defaults:
        domain: com.apple.driver.AppleBluetoothMultitouch.trackpad
        key: Clicking
        type: int
        value: 1
        state: present
      when: ('trackpad_tap_click' in (macos_settings | default([])))
      tags:
        - macos

    - name: Enable tap to click for current user
      osx_defaults:
        domain: com.apple.AppleMultitouchTrackpad
        key: Clicking
        type: int
        value: 1
        state: present
      when: ('trackpad_tap_click' in (macos_settings | default([])))
      tags:
        - macos

    - name: Set screenshot location
      osx_defaults:
        domain: com.apple.screencapture
        key: location
        type: string
        value: "~/Pictures/Screenshots"
        state: present
      when: ('screenshots_location' in (macos_settings | default([])))
      tags:
        - macos

    - name: Create Screenshots directory
      file:
        path: ~/Pictures/Screenshots
        state: directory
      when: ('screenshots_location' in (macos_settings | default([])))
      tags:
        - macos

    ###############
    # Restart services
    ###############
    - name: Restart Dock
      shell: killall Dock
      when: (macos_settings is defined) and (('dock_autohide' in macos_settings) or ('dock_size' in macos_settings))
      tags:
        - macos

    - name: Restart Finder
      shell: killall Finder
      when: (macos_settings is defined) and (('finder_show_extensions' in macos_settings) or ('finder_show_hidden' in macos_settings))
      tags:
        - macos

    ###############
    # Final Message
    ###############
    - name: Display completion message
      debug:
        msg: |
          âœ… Setup completed successfully!

          Installed packages:
          - Homebrew: {{ (homebrew_packages | default([]) | length) }} packages
          - Homebrew Cask: {{ (homebrew_cask_packages | default([]) | length) }} applications
          - App Store: {{ (appstore_apps | default([]) | length) }} apps
          - Dev Environments: {{ (development_environments | default([]) | length) }} tools
          - macOS Settings: {{ (macos_settings | default([]) | length) }} configurations

          Please restart your terminal for all changes to take effect.